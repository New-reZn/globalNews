import{Matrix4,Object3D,Vector3}from"./Three.js";class CSS2DObject extends Object3D{constructor(element=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=element,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(object){object.element instanceof Element&&null!==object.element.parentNode&&object.element.parentNode.removeChild(object.element)})})}copy(source,recursive){return super.copy(source,recursive),this.element=source.element.cloneNode(!0),this}}const _vector=new Vector3,_viewMatrix=new Matrix4,_viewProjectionMatrix=new Matrix4,_a=new Vector3,_b=new Vector3;class CSS2DRenderer{constructor(parameters={}){const _this=this;let _width,_height,_widthHalf,_heightHalf;const cache={objects:new WeakMap},domElement=void 0!==parameters.element?parameters.element:document.createElement("div");function getDistanceToSquared(object1,object2){return _a.setFromMatrixPosition(object1.matrixWorld),_b.setFromMatrixPosition(object2.matrixWorld),_a.distanceToSquared(_b)}domElement.style.overflow="hidden",this.domElement=domElement,this.getSize=function(){return{width:_width,height:_height}},this.render=function(scene,camera){!0===scene.matrixWorldAutoUpdate&&scene.updateMatrixWorld(),null===camera.parent&&!0===camera.matrixWorldAutoUpdate&&camera.updateMatrixWorld(),_viewMatrix.copy(camera.matrixWorldInverse),_viewProjectionMatrix.multiplyMatrices(camera.projectionMatrix,_viewMatrix),function renderObject(object,scene,camera){if(object.isCSS2DObject){_vector.setFromMatrixPosition(object.matrixWorld),_vector.applyMatrix4(_viewProjectionMatrix);const visible=!0===object.visible&&-1<=_vector.z&&_vector.z<=1&&!0===object.layers.test(camera.layers);if(object.element.style.display=!0==visible?"":"none",!0==visible){object.onBeforeRender(_this,scene,camera);const element=object.element;element.style.transform="translate(-50%,-50%) translate("+(_vector.x*_widthHalf+_widthHalf)+"px,"+(-_vector.y*_heightHalf+_heightHalf)+"px)",element.parentNode!==domElement&&domElement.appendChild(element),object.onAfterRender(_this,scene,camera)}const objectData={distanceToCameraSquared:getDistanceToSquared(camera,object)};cache.objects.set(object,objectData)}for(let i=0,l=object.children.length;i<l;i++)renderObject(object.children[i],scene,camera)}(scene,scene,camera),function(scene){var sorted=function(scene){const result=[];return scene.traverse(function(object){object.isCSS2DObject&&result.push(object)}),result}(scene).sort(function(a,b){return a.renderOrder!==b.renderOrder?b.renderOrder-a.renderOrder:cache.objects.get(a).distanceToCameraSquared-cache.objects.get(b).distanceToCameraSquared}),zMax=sorted.length;for(let i=0,l=sorted.length;i<l;i++)sorted[i].element.style.zIndex=zMax-i}(scene)},this.setSize=function(width,height){_width=width,_height=height,_widthHalf=_width/2,_heightHalf=_height/2,domElement.style.width=width+"px",domElement.style.height=height+"px"}}}export{CSS2DObject,CSS2DRenderer};